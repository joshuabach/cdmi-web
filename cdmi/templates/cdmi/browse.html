{% extends "cdmi/root.html" %}
{% load static %}
{% load utils %}

{% block head %}
<script>
  function getCapabilities(url) {
      $('#changeqos').modal('show');
  };

  function changeqos(file_path, type, target_capability) {
    $.get("{% url 'cdmi:object_info' site.id '' %}" + target_capability, function(data) {
      var target_capability_metadata = data.metadata;

      $('#changeqos-file-name')[0].innerHTML = file_path;
      $('#changeqos-object-name')[0].innerHTML = target_capability.split('/').pop();
      $('#changeqos-object-latency')[0].innerHTML = target_capability_metadata.cdmi_latency;
      $('#changeqos-object-copies')[0].innerHTML = target_capability_metadata.cdmi_data_redundancy;
      $('#changeqos-object-location')[0].innerHTML = target_capability_metadata.cdmi_geographic_placement;
      $('#changeqos-object-transitions')[0].innerHTML = target_capability_metadata.cdmi_capabilities_allowed;

      $('#changeqos-form').attr('action', "{% url 'cdmi:update' site.id '' %}" + file_path)
      $('#changeqos-form').children('input[name=qos]').attr('value', target_capability)
      $('#changeqos-form').children('input[name=type]').attr('value', type)

      $('#changeqos').modal('show');
    });
  };

  $.fn.poll = function(timeout) {
    return this.each(function() {
      var entry = $(this);

      var select = $("#select-" + entry.attr('data-id'));
      var progress = $("#progress-" + entry.attr('data-id'));
      var target = $("#target-" + entry.attr('data-id'));
      var qos = $("#qos-" + entry.attr('data-id'));

      select.css('display', 'none');
      progress.css('display', 'block');
      target.css('display', 'block');
      select.children('ul[class=dropdown-menu]').empty();

      setTimeout(function() {
        var url = "{% url 'cdmi:object_info' site.id path %}/" + entry.attr('data-name');

        $.get(url, function(data) {
          if ('cdmi_recommended_polling_interval' in data.metadata) {
            var next_timeout = data.metadata.cdmi_recommended_polling_interval;
            console.log("Polled %o, still in transition. Sleeping %o", url, next_timeout) ;
            entry.poll(next_timeout);
          } else {
            console.log("Polled %o, transition finished", url) ;
            progress.css('display', 'none');
            target.css('display', 'none');
            select.css('display', 'block');

            var new_capability = data.capabilitiesURI.split('/').pop();
            qos[0].innerHTML = new_capability;

            // now we have to update the possible target capabilities
            var capabilities_allowed = data.metadata.cdmi_capabilities_allowed_provided;
            if (capabilities_allowed.length > 0) {
              // TODO
              capabilities_allowed.forEach(function(target_capability) {
                select.children('ul[class=dropdown-menu]').append(
                  $('<li>').append(
                    $('<button>').attr('class', 'btn btn-link')
                                 .click(function() {
                                          changeqos("{{ path }}/"+entry.attr('data-name'),
                                                    entry.attr('data-type'),
                                                    target_capability);
                                        }).append(
                       target_capability.split('/').pop()
              )))});
              } else {
                select.children('[class=dropdown-toggle]').css('cursor', 'not-allowed');
                select.children('[class=dropdown-toggle]').css('text-decoration', 'none');
                select.children('[class=dropdown-toggle]').attr('title', 'No transitions available for ' + new_capability);
            }
         }
        });
      }, timeout)
    })
  };

</script>
{% endblock %}

{% block body %}
<div class="container">
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        {% if site.logo_uri %}
        <a class="navbar-brand" style="padding: 5px 15px"><img src="{{ site.logo_uri }}" height="40"></a>
        {% endif %}
        <a class="navbar-brand" href="#"><strong>{{ site.site_uri }}</strong>/{{ path }}</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <button data-toggle="modal"
                    {% if not site.can_browse %}
                    title="Unavailable for this CDMI site"
                    {% else %}
                    data-target="#mkdir"
                    {% endif %}
                    class="btn btn-primary
                           {% if not site.can_browse %}disabled{% endif %}">
              Create Directory
            </button>
          </li>
          <li>
            <button data-toggle="modal"
                    {% if not site.can_browse %}
                    title="Unavailable for this CDMI site"
                    {% else %}
                    data-target="#upload"
                    {% endif %}
                    class="btn btn-primary
                           {% if not site.can_browse %}disabled{% endif %}">
              Upload File
            </button>
          </li>
        </ul>
      </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
  </nav>
</div>

<div class="container">
  <table class="table sortable" style="font-size:14px">
    <thead><tr>
        <th data-defaultsort="asc">Name</th>
        <th>Type</th>
        <th>Current QoS</th>
        <th data-defaultsort="disabled"></th>
        <th data-defaultsort="disabled">Target QoS</th>
        <th data-defaultsort="disabled"></th>
    </thead>
    <tbody>
      {% if path and path != '.' %}
      <tr>
        <td>
          <a href="{% url 'cdmi:browse' site.id path|dirname %}" method="get">
            ..
          </a>
        </td>
        <td>Directory</td>
        <td></td>
        <td></td>
        <td></td>
        <td>
            <div class="btn bare-btn btn-small" style="color: white">nil</div>
        </td>
      </tr>
      {% endif %}
      {% for o in object_list %}
      <tr>
        {% if o.type == "File" %}
        <td>
          {{ o.name }}
        </td>
        {% else %}
        <td>
          <a href="{% if path %}
                    {% url 'cdmi:browse' site.id path|add:"/"|add:o.name %}
                   {% else %}
                    {% url 'cdmi:browse' site.id o.name %}
                   {% endif %}">
            {{ o.name }}
          </a>
        </td>
        {% endif %}
        <td>
          {{ o.type }}
        </td>
        <td id="qos-{{ o.name|slugify }}">
          {{ o.capabilities_name }}
        </td>
        <td style="width: 200px">
          <img id="progress-{{ o.name|slugify }}"
               src="{% static 'cdmi/img/progress.gif' %}"
               style="display: none"
               alt="loading" width="150">
        </td>
        <td id="entry-{{ o.name|slugify }}"
            data-name="{{ o.name }}"
            data-id="{{ o.name|slugify }}">
          <div id="target-{{ o.name|slugify }}"
              style="display: none">
            {{ o.capabilities_target|basename }}
          </div>
          <div id="select-{{ o.name|slugify }}"
               class="dropdown">
            <!-- <li class="dropdown"> -->
            <a href="#" class="dropdown-toggle
                               {% if not o.capabilities_allowed %}disabled{% endif %}"
               {% if not o.capabilities_allowed %}
               style="cursor: not-allowed; text-decoration: none"
               title="No transitions available for {{ o.capabilities_name }}"
               {% endif %}
               data-toggle="dropdown" role="button"
               aria-haspopup="true" aria-expanded="false">
              Select<span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
              {% for allowed in o.capabilities_allowed %}
              <li>
                <button class="btn btn-link"
                        onclick="changeqos('{{ path }}/{{ o.name }}', '{{ o.type }}', '{{ allowed }}')">
                  {{ allowed|basename }}
                </button>
              </li>
              {% endfor %}
            </ul>
            <!-- </li> -->
          </div>
        </td>
        <td>
          <form action="{% url 'cdmi:delete' site.id path %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="name" value="{{ o.name }}" />
            <button class="btn bare-btn btn-small
                           {% if not site.can_browse %}disabled{% endif %}"
                    {% if not site.can_browse %}
                    title="Unavailable for this CDMI site"
                    {% endif %}
                    type="submit" style="color: red">Delete</button>
          </form>
        </td>
      </tr>
      <script>
        {% if o.capabilities_polling %}
        $("#entry-{{ o.name|slugify }}").poll({{ o.capabilities_polling }});
        {% endif %}
      </script>
      {% endfor %}
    </tbody>
  </table>
  {% if messages %}
  <table class="table">
    <tbody>
      {% for message in messages %}
      <tr{% if message.tags %} class="{{ message.tags }}"{% endif %}>
        <td>{{ message }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
</div>

<!-- Modal -->
<div class="modal fade" id="upload" tabindex="-1" role="dialog" aria-labelledby="uploadLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="uploadLabel">Upload file</h4>
      </div>
      <div class="modal-body">
        <form action="{% url 'cdmi:upload' site.id path %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-group">
            <input type="file" id="file" name="file">
            <p class="help-block">Search for files to upload.</p>
            {#<input type="hidden" name="path" value="{{ path }}" />#}
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="mkdir" tabindex="-1" role="dialog" aria-labelledby="mkdirLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="mkdirLabel">Create Directory</h4>
      </div>
      <div class="modal-body">
        <form action="{% url 'cdmi:mkdir' site.id path %}" method="post">
          {% csrf_token %}
          <div class="form-group">
            <input type="text" id="name" name="name">
            <p class="help-block">Name of directory</p>
            {#<input type="hidden" name="path" value="{{ path }}" />#}
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="changeqos" tabindex="-1" role="dialog" aria-labelledby="changeqosLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="changeqosLabel">
          Change Quality-of-Service of <em id="changeqos-file-name"></em>
        </h4>
      </div>
      <div class="modal-body">
        <table class="table" style="font-size:14px">
          <thead>
            <tr>
              <th>To <em id="changeqos-object-name"></em></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Latency:</td>
              <td id="changeqos-object-latency"></td>
            </tr>
            <tr>
              <td>Number of copies:</td>
              <td id="changeqos-object-copies"></td>
            </tr>
            <tr>
              <td>Locations:</td>
              <td id="changeqos-object-location"></td>
            </tr>
            <tr>
              <td>Allowed transitions:</td>
              <td id="changeqos-object-transitions"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <form action="url 'cdmi:update' site.id object_info.path" method="post" id="changeqos-form">
          {% csrf_token %}
          <input type="hidden" name="qos"></input>
          <input type="hidden" name="type"></input>
          <input type="hidden" name="next" value="{% url 'cdmi:browse' site.id path %}"></input>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cancle</button>
          <button type="submit" class="btn btn-success">Change</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
